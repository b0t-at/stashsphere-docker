name: stashsphere

services:
  postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${STASHSPHERE_DB_NAME:-stashsphere}
      POSTGRES_USER: ${STASHSPHERE_DB_USER:-stashsphere}
      POSTGRES_PASSWORD: ${STASHSPHERE_DB_PASSWORD:?set STASHSPHERE_DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10

  stashsphere-frontend:
    image: ${STASHSPHERE_FRONTEND_IMAGE:-ghcr.io/b0t-at/stashsphere-frontend:latest}
    restart: unless-stopped
    environment:
      STASHSPHERE_API_HOST: ${STASHSPHERE_PUBLIC_API_HOST:-https://stash.example.com}
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.stashsphere-frontend.rule=Host(`${TRAEFIK_HOST:?set TRAEFIK_HOST}`)
      - traefik.http.routers.stashsphere-frontend.entrypoints=https
      - traefik.http.routers.stashsphere-frontend.tls=true
      - traefik.http.routers.stashsphere-frontend.tls.certresolver=${TRAEFIK_CERTRESOLVER:-letsencrypt}
      - traefik.http.routers.stashsphere-frontend.priority=10
      - traefik.http.services.stashsphere-frontend.loadbalancer.server.port=80

  stashsphere-backend:
    image: ${STASHSPHERE_BACKEND_IMAGE:-ghcr.io/b0t-at/stashsphere-backend:latest}
    user: ${STASHSPHERE_CONTAINER_UID:-10001}:${STASHSPHERE_CONTAINER_GID:-10001}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      STATE_DIRECTORY: /data
      CACHE_DIRECTORY: /data
      STASHSPHERE_CONFIG_DIR: /config
      STASHSPHERE_CONFIG_FILE: stashsphere.yaml
      STASHSPHERE_SECRETS_FILE: secrets.yaml
      STASHSPHERE_AUTO_CREATE_CONFIG: ${STASHSPHERE_AUTO_CREATE_CONFIG:-true}
      STASHSPHERE_AUTO_MIGRATE: ${STASHSPHERE_AUTO_MIGRATE:-true}
      STASHSPHERE_DB_HOST: ${STASHSPHERE_DB_HOST:-postgres}
      STASHSPHERE_DB_PORT: ${STASHSPHERE_DB_PORT:-5432}
      STASHSPHERE_DB_USER: ${STASHSPHERE_DB_USER:-stashsphere}
      STASHSPHERE_DB_NAME: ${STASHSPHERE_DB_NAME:-stashsphere}
      STASHSPHERE_DB_PASSWORD: ${STASHSPHERE_DB_PASSWORD:?set STASHSPHERE_DB_PASSWORD}
      STASHSPHERE_DB_SSLMODE: ${STASHSPHERE_DB_SSLMODE:-disable}
      STASHSPHERE_FRONTEND_URL: ${STASHSPHERE_FRONTEND_URL:-https://stash.example.com}
      STASHSPHERE_ALLOWED_ORIGIN: ${STASHSPHERE_ALLOWED_ORIGIN:-https://stash.example.com}
      STASHSPHERE_API_DOMAIN: ${STASHSPHERE_API_DOMAIN:-stash.example.com}
      STASHSPHERE_INSTANCE_NAME: ${STASHSPHERE_INSTANCE_NAME:-My StashSphere}
      STASHSPHERE_LISTEN_ADDRESS: :8081
    volumes:
      - ./config:/config
      - ./data/image_store:/data/image_store
      - ./data/image_cache:/data/image_cache
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.stashsphere-backend-api.rule=Host(`${TRAEFIK_HOST:?set TRAEFIK_HOST}`) && (PathPrefix(`/api`) || PathPrefix(`/swagger`) || (PathPrefix(`/assets/`) && !PathRegexp(`^/assets/.*\..*`)))
      - traefik.http.routers.stashsphere-backend-api.entrypoints=https
      - traefik.http.routers.stashsphere-backend-api.tls=true
      - traefik.http.routers.stashsphere-backend-api.tls.certresolver=${TRAEFIK_CERTRESOLVER:-letsencrypt}
      - traefik.http.routers.stashsphere-backend-api.priority=100
      - traefik.http.services.stashsphere-backend-api.loadbalancer.server.port=8081

networks:
  proxy:
    external: true
    name: proxy

volumes:
  postgres_data:
